# Azure Policy Impact Assessment

## Get-AzPolicyImpactReport PowerShell Function

### Purpose

`Get-AzPolicyImpactReport` executed locally or from the Azure Cloud Shell generates comprehensive reports analyzing Azure Policy assignments that could impact your resource deployments. It retrieves complete policy definitions including PolicyRule, PolicyParameters, and PolicyDefinitions across Management Group, Subscription, and Resource Group scopes. The report identifies which policies will block deployments versus those that only audit, analyzes your permission context to detect potential blind spots, and exports all data in JSON format for deployment planning and exemption requests. This enables you to understand Azure Policy requirements **before** attempting deployment, eliminating trial-and-error approaches to policy compliance.

---

### Table of Contents

1. [Quick Start](#quick-start)
1. [Output & How to Interpret Results](#output--how-to-interpret-results)
1. [Prerequisites](#prerequisites)
1. [Parameters](#parameters)
1. [Example Usage & Scenarios](#example-usage--scenarios)
1. [Understanding Policy Effects](#understanding-policy-effects)
1. [Additional Notes](#additional-notes)
1. [Advanced Usage](#advanced-usage)

---

### Quick Start

1. **Connect to Azure** (if not already authenticated)
   - **In Azure Cloud Shell:** Automatically authenticated when session starts
   - **Locally:** Run `Connect-AzAccount` to authenticate

2. **Download and import the module**

   - In a default Azure Cloud Shell or Local PowerShell Session with access to GitHub:
     ```powershell
     Invoke-WebRequest -Uri https://raw.githubusercontent.com/silk-us/scripts-and-configs/refs/heads/main/Azure/Policy%20Impact%20Assessment/Get-AzPolicyImpactReport.psm1 | Select-Object -ExpandProperty Content | Out-File .\Get-AzPolicyImpactReport.psm1 -Force; if (Get-Item -Path .\Get-AzPolicyImpactReport.psm1 -Stream "Zone.Identifier" -ErrorAction SilentlyContinue){ Unblock-File -Path .\Get-AzPolicyImpactReport.psm1 }; Import-Module -Force .\Get-AzPolicyImpactReport.psm1 -Verbose
     ```

   - In an Isolated Azure Cloud Shell or Local PowerShell Session without internet access:
     1. Download the [Get-AzPolicyImpactReport module file](Get-AzPolicyImpactReport.psm1) into your working directory
     2. Import the module:
        ```powershell
        Import-Module ".\Get-AzPolicyImpactReport.psm1"
        ```
        > You may need to unblock the file: `Unblock-File -Path .\Get-AzPolicyImpactReport.psm1`

3. **Run the function**

   **Interactive mode** (easiest - prompts for selections):
   ```powershell
   Get-AzPolicyImpactReport
   ```
   > Prompts for subscription selection (if multiple available), then displays menu of resource groups to analyze. Press Enter to skip resource group and analyze subscription scope only.

   **Specify a resource group directly:**
   ```powershell
   Get-AzPolicyImpactReport -FlexResourceGroupName "my-flex-rg"
   ```
   > Automatically searches for the resource group across all accessible subscriptions. If found in one subscription, uses it automatically. If found in multiple subscriptions, prompts to select which one. Analyzes all policies that apply to the specified resource group from Management Group, Subscription, and Resource Group scopes.

   **Multi-resource group analysis:**
   ```powershell
   Get-AzPolicyImpactReport `
       -FlexResourceGroupName "silk-flex-rg" `
       -VNetResourceGroup "network-rg" `
       -NSGResourceGroup "nsg-rg" `
       -UMIResourceGroup "identity-rg"
   ```
   > Analyzes policies across multiple resource groups where your Flex deployment resources will be located. Useful when networking and identity resources are in separate resource groups.

   **Identify Scopes from individual resources:**
   ```powershell
   Get-AzPolicyImpactReport `
       -FlexResourceGroupName "silk-flex-rg" `
       -VNetName "shared-vnet" `
       -NSGName "silk-flex-nsg" `
   ```
   > Searches for named resources across all resource groups, automatically determines their locations, and analyzes applicable policies. If multiple resources have the same name, prompts to select which one.

4. **Review results** in the console output and JSON report `.\AzurePolicyImpactReport-[Date_TimeStamp].json` (defaults to working directory)

---

### Output & How to Interpret Results

- **Console Output:** Real-time policy collection status, permission analysis, scope summary showing Management Group/Subscription/Resource Group policy counts, and blind spot warnings
- **JSON Report:** Generated by default. Includes:
  - **Metadata:** Report timestamp, subscription, resource group (if specified), analysis scope, generated by user
  - **PolicyAssignments:** Complete policy data including:
    - Policy name, display name, scope, and enforcement mode
    - **Effect:** Critical indicator - "deny" blocks deployment, "audit" only logs
    - **PolicyRule:** Complete policy logic showing exact requirements
    - **PolicyParameters:** Parameter definitions and allowed values
    - **PolicyDefinitions:** For initiatives, all member policy definitions
  - **PermissionContext:** Your role assignments and access levels
  - **PotentialBlindSpots:** Areas where you lack visibility with severity ratings and recommendations
  - **ScopeAnalysis:** Summary statistics showing policy counts by scope (MG/Sub/RG)
  - **PolicyExemptions:** Any exemptions overriding policy enforcement
  - **ResourcesAnalyzed:** VNets, NSGs, UMIs analyzed (if specified)
  - **AccessIssues:** Policies or scopes that couldn't be accessed due to permissions

> **Key Insight:** Focus on policies with `"Effect": "deny"` - these will block your deployment if requirements aren't met.

> **Troubleshooting:** If you encounter issues, add `-Verbose` for detailed output. This can help identify problems with authentication, policy retrieval, permission issues, etc.

---

### Prerequisites

> The function will validate prerequisites and guide you through missing requirements.

- **Azure Account:** You must be authenticated to Azure. Use `Connect-AzAccount` to authenticate before running the function.
  > - The function will prompt you if not authenticated in a pop-up account selection window
  > - Azure Cloud Shell is automatically authenticated when you start your session
- **Azure Reader Role:** An account with Reader or equivalent permissions. Minimum:
  - **Subscription Reader** - Required to collect subscription and resource group level policies
  - **Management Group Reader** - Recommended for complete visibility into management group policies
  > Without Management Group Reader access, management group-scoped policies may not be visible. The module detects this and reports it as a potential blind spot.

##### Azure PowerShell Module Prerequisites

> **Note:** Azure Cloud Shell PowerShell environments have the full module pre-installed.

- **Azure PowerShell Modules (Az):** Specifically these Azure PowerShell submodules are required. Having the [entire Az module installed](https://learn.microsoft.com/en-us/powershell/azure/install-azure-powershell) satisfies this requirement.
  - [**Az.Accounts**](https://learn.microsoft.com/en-us/powershell/module/az.accounts/) - Provides authentication and context management for Azure sessions
  - [**Az.Resources**](https://learn.microsoft.com/en-us/powershell/module/az.resources/) - Manages policy assignments, definitions, and exemptions
  - [**Az.Network**](https://learn.microsoft.com/en-us/powershell/module/az.network/) - Required if analyzing VNets or NSGs
  - [**Az.ManagedServiceIdentity**](https://learn.microsoft.com/en-us/powershell/module/az.managedserviceidentity/) - Required if analyzing User-Assigned Managed Identities

**Required Azure PowerShell Modules Installation Command:**
```powershell
Install-Module -Name Az.Accounts,Az.Resources,Az.Network,Az.ManagedServiceIdentity -Repository PSGallery -Scope CurrentUser
```

> **Note:** The function will validate module availability on execution. Manual installation is recommended for first-time use or restricted environments.

---

### Parameters

| Parameter | Description | Valid Input | Example |
|-----------|-------------|-------------|---------|
| `-SubscriptionId` | Azure Subscription ID to analyze. **Optional** - if not provided, uses current context subscription | Azure Subscription GUID | "12345678-1234-1234-1234-123456789012" |
| `-SubscriptionName` | Azure Subscription Name (alternative to SubscriptionId). **Optional** - if not provided, uses current context subscription | Existing subscription name | "Production-Azure" |
| `-FlexResourceGroupName` | Target Flex resource group for deployment. **Optional** - omit for subscription-level analysis | Existing Azure RG | "silk-flex-rg" |
| `-VNetName` | Array of Virtual Network names to analyze | VNet names | @("shared-vnet", "prod-vnet") |
| `-VNetResourceGroup` | Resource group where VNet will be deployed | Existing Azure RG | "network-rg" |
| `-NSGName` | Array of Network Security Group names to analyze | NSG names | @("silk-flex-nsg", "silk-cluster-nsg") |
| `-NSGResourceGroup` | Resource group where NSGs will be deployed | Existing Azure RG | "network-rg" |
| `-UMIName` | Array of User-Assigned Managed Identity names to analyze | UMI names | @("silk-flex-umi") |
| `-UMIResourceGroup` | Resource group where UMIs will be deployed | Existing Azure RG | "identity-rg" |
| `-OutputPath` | Directory path where JSON report will be saved. **Default:** Current working directory | Valid path | "C:\\Reports" |

---

### Example Usage & Scenarios

#### 1. Subscription-Level Analysis (No Resource Group)
```powershell
Get-AzPolicyImpactReport -SubscriptionName "Production-Azure"
```
> Analyzes all policies at Management Group and Subscription scopes without targeting a specific resource group. Useful for understanding organization-wide policy landscape.

#### 2. Custom Output Location
```powershell
Get-AzPolicyImpactReport `
    -FlexResourceGroupName "customer-flex-rg" `
    -OutputPath "C:\\CustomerReports"
```
> Saves the JSON report to a specific directory. Useful for organizing reports by customer or deployment.

#### 3. Pre-Deployment Assessment
```powershell
Get-AzPolicyImpactReport `
    -FlexResourceGroupName "planned-deployment-rg" `
    -VNetResourceGroup "network-rg" `
    -NSGResourceGroup "network-rg"
```
> Analyzes policies for planned deployment before any resources exist. Identifies potential blockers early in the planning phase.

#### 4. UMI Deployment Identify Scopes from individual resources:
   ```powershell
   Get-AzPolicyImpactReport `
       -FlexResourceGroupName "silk-flex-rg" `
       -VNetName "shared-vnet" `
       -NSGName "silk-flex-nsg", "silk-cluster-nsg" `
       -UMIName "silk-flex-umi"
   ```
   > Searches for named resources across all resource groups, automatically determines their locations, and analyzes applicable policies. If multiple resources have the same name, prompts to select which one.


---

### Understanding Policy Effects

- **No Azure Resources Created:** This module only reads policy data via Azure REST API - no test resources are deployed
- **Report Retention:** JSON reports include complete policy rules for audit trails and deployment documentation
- **Permission Awareness:** The module automatically detects your access level and reports potential blind spots where you may lack visibility

---

## Advanced Usage

### Filtering and Analyzing Report Data

After generating a report, use PowerShell to filter and analyze the data:

```powershell
# Load the report
$report = Get-AzPolicyImpactReport -FlexResourceGroupName "silk-flex-rg"

# Show only deny policies (will block deployment)
$report.PolicyAssignments | Where-Object { $_.Effect -eq 'deny' } |
    Select-Object AssignmentDisplayName, ScopeType, PolicyDisplayName

# Show policies impacting your target resource group
$report.PolicyAssignments | Where-Object { $_.ImpactsTargetResourceGroup -eq $true } |
    Format-Table AssignmentDisplayName, Effect, EnforcementMode

# Deep dive into a specific policy's rules
$policy = $report.PolicyAssignments | Where-Object { $_.AssignmentDisplayName -like '*Allowed locations*' }
$policy.PolicyRule | ConvertTo-Json -Depth 10
```

### Comparing Policies Across Multiple Subscriptions

```powershell
# Collect reports from multiple subscriptions
$subscriptions = @('Sub-Dev', 'Sub-Test', 'Sub-Prod')
$reports = @{}

foreach ($sub in $subscriptions) {
    Set-AzContext -SubscriptionName $sub
    $reports[$sub] = Get-AzPolicyImpactReport -FlexResourceGroupName 'flex-rg'
}

# Compare policy counts
$reports.Keys | ForEach-Object {
    [PSCustomObject]@{
        Subscription = $_
        TotalPolicies = $reports[$_].ScopeAnalysis.TotalPolicies
        DenyPolicies = ($reports[$_].PolicyAssignments | Where-Object {$_.Effect -eq 'deny'}).Count
    }
} | Format-Table
```

### Planning Policy Exemptions

```powershell
$report = Get-AzPolicyImpactReport -FlexResourceGroupName "silk-flex-rg"

# Find policies that may need exemptions
$denyPolicies = $report.PolicyAssignments | Where-Object { $_.Effect -eq 'deny' }

# Review each policy's requirements
foreach ($policy in $denyPolicies) {
    Write-Host "Policy: $($policy.AssignmentDisplayName)" -ForegroundColor Yellow
    Write-Host "Scope: $($policy.ScopeType)" -ForegroundColor Gray
    $policy.PolicyRule | ConvertTo-Json -Depth 5
    Write-Host "`n---`n"
}
```

### Using Verbose Output for Troubleshooting

```powershell
Get-AzPolicyImpactReport -FlexResourceGroupName "silk-flex-rg" -Verbose
```
> Provides detailed output showing policy collection progress, REST API calls, permission checks, and resource resolution steps. Useful for diagnosing issues or understanding what the module is doing.

---

## Best Practices

1. **Run Early** - Execute policy analysis during the planning phase, before deploying any resources
2. **Check Blind Spots** - Review the PermissionContext section to ensure you have complete visibility. Request Management Group Reader access if needed
3. **Focus on Deny Policies** - Policies with "deny" effect will block deployment - prioritize reviewing these
4. **Include All Resources** - Specify all VNets, NSGs, and UMIs that will be used in your deployment for complete analysis
5. **Review PolicyRule Details** - Don't just look at effects; examine the complete PolicyRule to understand exact requirements
6. **Document Exemptions** - Use policy rule details to justify exemption requests with specific policy logic
7. **Re-run After Changes** - If organizational policies change, regenerate the report before deployment
8. **Save Reports** - Keep JSON reports for audit trails and deployment documentation

---

## License

Copyright Â© 2026 Silk Technologies Inc. All rights reserved.
