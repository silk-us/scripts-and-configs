# Silk Azure Resource Availability Check

## Test-SilkResourceDeployment Powershell Function

##### **Silk Version:** The Silk Architecture Modeled in the basic operation of this Function Version: 1.97.9-1.0.1 supports Silk SDP configurations for version 1.97.9

### Purpose

`Test-SilkResourceDeployment` executed locally or from the Azure Cloud Shell this function validates whether your Silk Data Pod deployment requirements can be met in your Azure environment. It models Azure resources that would compose components of a given Silk Data Pod configuration; checks for Region and Zone VM SKU support, relevant environment quota limits and tests actual available sku capacity by quickly deploying VMs with the same constraints Silk Flex orchestrates.  The result provides a report clearly showing whether your deployment will succeed without the need to attempt an actual Silk Data Pod deployment.  This function is capable of modeling all use cases; an entire Silk Data Pod configuration, only the front end CNodes, or only Media Nodes composed of DNode VMs.  Typically this would deploy the test resources into an existing resource group, ideally the empty resource group the Silk Flex and Data Pod deployment will target.

---

### Table of Contents


1. [Quick Start with Checklist JSON](#quick-start-with-checklist-json)
1. [Output & How to Interpret Results](#output--how-to-interpret-results)
1. [Prerequisites](#prerequisites)
1. [Parameters](#parameters)
1. [Example Usage & Scenarios](#example-usage--scenarios)
1. [Additional Notes](#additional-notes)
1. [Advanced Usage](#advanced-usage)
    - [Advanced Parameters](#advanced-parameters)
    - [Advanced Examples](#advanced-examples)

---

### Quick Start with Checklist JSON

1. Save your Silk deployment checklist JSON configuration as a JSON file and upload it into the working directory of your Azure Cloud Shell or Local Powershell Session.
1. Download and import the [Test-SilkResourceDeployment module file](Test-SilkResourceDeployment.psm1)
    + In a default Azure Cloud Shell or Local Powershell Session with access to github
        1. Run this command to download and import the [Test-SilkResourceDeployment module](Test-SilkResourceDeployment.psm1)
            >```powershell
            >Invoke-WebRequest -Uri https://raw.githubusercontent.com/silk-us/scripts-and-configs/refs/heads/main/Azure/Resource%20Availability%20Check/Test-SilkResourceDeployment.psm1 | Select-Object -ExpandProperty Content | Out-File .\Test-SilkResourceDeployment.psm1 -Force; if (Get-Item -Path .\Test-SilkResourceDeployment.psm1 -Stream "Zone.Identifier" -ErrorAction SilentlyContinue){ Unblock-File -Path .\Test-SilkResourceDeployment.psm1 }; Import-Module -Force .\Test-SilkResourceDeployment.psm1 -Verbose
            >```

    + In an Isolated Azure Cloud Shell or Local Powershell Session without internet access
        1. Download the [Test-SilkResourceDeployment module file](Test-SilkResourceDeployment.psm1) into the working directory of your Azure Cloud Shell Session
        1. In Cloud Shell import the module:
            >```powershell
            >Import-Module ".\Test-SilkResourceDeployment.psm1"
            >```
            >>* You may need to unblock the file: `Unblock-File -Path .\Test-SilkResourceDeployment.psm1`
1. Run the function with your configuration file:
    >```powershell
    >Test-SilkResourceDeployment -ChecklistJSON ".\silk-checklist.json"
    >```
1. Review results in the console output and HTML report `.\SilkDeploymentReport_[Date_TimeStamp].html` (defaults to working directory).

---

### Output & How to Interpret Results

- **Console Output:** Comprehensive deployment status, resource validation, SKU availability, quota summaries, and progress tracking.
- **HTML Report:** Generated by default. Includes:
  - Silk Data Pod component summary (CNodes, MNodes, DNodes)
  - Deployment status for each resource
  - Availability checks for all relevant quotas
  - SKU support analysis for region and zone
  - Infrastructure resource details (VNet, NSG, PPG, AvSets)
  - Any issues or recommendations
- **Resource Cleanup:** By default, all test resources are removed after validation unless `-DisableCleanup` is specified.

> **Troubleshooting:** If you encounter issues, add `-Verbose` for detailed output. This can help identify problems with authentication, resource creation, quota limits etc.

---

### Prerequisites
> The function will guide you through missing prerequisites and handle most setup steps automatically.

- **Azure Resource Group**: Must exist unless using `-CreateResourceGroup` (which requires **subscription-level** permissions).
- **Azure Resource Group Contributor Role**: An account with Contributor or equivalent permissions in the target resource group.
- **Azure Account**: You must be authenticated to Azure, You may use `Connect-AzAccount` to authenticate before running the function.
    >- The function will prompt you if not authenticated in a pop up account selection window.
    >- Azure Cloud Shell will be automatically authenticated when you start your session.
- **Configuration File (Recommended)**: If you provide a Silk Deployment Checklist JSON configuration all required parameters are passed in for you.
##### Azure PowerShell Module Prerequisites
> **Note:** Azure Cloud Shell Powershell environments have the full module pre-installed.
- **Azure PowerShell Modules (Az)**: Specifically these Azure Powershell submodules listed are required, of course having the [entire Az module installed](https://learn.microsoft.com/en-us/powershell/azure/install-azure-powershell) satisfies this requirement.
    - [**Az.Accounts**](https://learn.microsoft.com/en-us/powershell/module/az.accounts/)  - Provides authentication and context management for Azure sessions.
    - [**Az.Resources**](https://learn.microsoft.com/en-us/powershell/module/az.resources/) - Manages Azure resource groups and resource operations.
    - [**Az.Compute**](https://learn.microsoft.com/en-us/powershell/module/az.compute/)   - Handles VM creation, SKU validation, and quota checks.
    - [**Az.Network**](https://learn.microsoft.com/en-us/powershell/module/az.network/)   - Manages networking resources such as VNets and subnets.

**Required Azure PowerShell Modules Installation Command:**
```powershell
Install-Module -Name Az.Accounts,Az.Resources,Az.Compute,Az.Network -Repository PSGallery -Scope CurrentUser
```

> **Note:** The function will validate and attempt to install any missing modules automatically, but manual installation is recommended for first-time use or restricted environments.


---

### Parameters

#### Required and Standard Usage Parameters
**Note:** All CNode and MNode type/size/sku/count parameters have specific allowed values that you can tab through to select or auto-complete.
**Note:** Region parameter has specific allowed values based on existing Azure Locations that you can tab through to select or auto-complete.

| Parameter               | Description | Valid Input | Example | Overrides ChecklistJSON |
|-------------------------|-------------|-------------|---------|-------------------------|
| `-SubscriptionId`       | Azure Subscription ID where resources will be deployed. | Azure Subscription GUID | "12345678-1234-1234-1234-123456789012" | ☑️ |
| `-ResourceGroupName`    | Azure Resource Group name. | Existing Azure RG | "silk-test-rg" | ☑️ |
| `-Region`               | Azure region for deployment. | [Valid Azure Location](https://learn.microsoft.com/en-us/azure/reliability/regions-list) | "eastus" | ☑️ |
| `-Zone`                 | Azure Availability Zone [Check Presence in Region](https://datacenters.microsoft.com/globe/explore/?view=table)  | "1", "2", "3", "Zoneless" | "1" | ☑️ |
| `-ChecklistJSON`        | Path to Silk deployment checklist JSON file. | [Example format of expected JSON Structure](silk-deployment-checklist-example.json) | "C:\\configs\\silk-deployment.json" | ⬜️ |
| `-CNodeFriendlyName`    | CNode SKU selection by Flex terminology | <br> Increased_Logical_Capacity (Standard_E64s_v5)<br> Read_Cache_Enabled (Standard_L64s_v3)<br> No_Increased_Logical_Capacity (Standard_D64s_v5) | "Increased_Logical_Capacity" | ⬜️ |
| `-CNodeCount`           | Number of CNode VMs | Minimum of 2 -> Maximum of 8 | 2 | ⬜️ |
| `-MnodeSizeLsv3`        | List of MNodes represented by storage capacity for Lsv3 SKUs | <br> "19.5" TiB (Standard_L8s_v3)<br> "39.1" TiB (Standard_L16s_v3)<br> "78.2" TiB (Standard_L32s_v3) | @("19.5", "39.1") | ⬜️ |
| `-MnodeSizeLaosv4`      | List of MNodes represented by storage capacity for Laosv4 SKUs | <br> "14.67" TiB (Standard_L2aos_v4)<br> "29.34" TiB (Standard_L4aos_v4)<br> "58.67" TiB (Standard_L8aos_v4)<br> "88.01" TiB (Standard_L12aos_v4)<br> "117.35" TiB (Standard_L16aos_v4) | @("14.67", "29.34") | ⬜️ |

---

### Example Usage & Scenarios

#### 1. Test with configuration from Silk Deployment Checklist JSON
```powershell
Test-SilkResourceDeployment -ChecklistJSON "C:\configs\silk-deployment.json"
```
   >Loads Subscription, Resource Group, Region and Zone parameters from the JSON file as well as CNode Type and Count, MNode Size and Count.

#### 2. Test by Friendly Name CNode and Laosv4 MNode by Size Selections
```powershell
Test-SilkResourceDeployment -SubscriptionId "12345678-1234-1234-1234-123456789012" -ResourceGroupName "silk-test-rg" -Region "eastus" -Zone "1" -CNodeFriendlyName "Increased_Logical_Capacity" -CNodeCount 2 -MnodeSizeLaosv4 @("14.67","29.34")
```
   >Test deployment in given Subscription, Resource Group, Region and Zone with two CNodes providing Increased Logical Capacity capability and two Laosv4 MNodes one with 14.67 TiB and second with 29.34 TiB storage capacity.

#### 3. Test MNode Only by Laosv4 MNode by Size Selection
```powershell
Test-SilkResourceDeployment -SubscriptionId "12345678-1234-1234-1234-123456789012" -ResourceGroupName "silk-test-rg" -Region "eastus" -Zone "1" -MnodeSizeLaosv4 @("58.67","117.35")
```
   >Test deployment in given Subscription, Resource Group, Region and Zone with two Laosv4 MNodes one with 58.67 TiB and second with 117.35 TiB storage capacity.

#### 4. Test CNode Only Maximum Count by Friendly Name CNode Selection
```powershell
Test-SilkResourceDeployment -SubscriptionId "12345678-1234-1234-1234-123456789012" -ResourceGroupName "silk-prod-rg" -Region "centralus" -Zone "3" -CNodeFriendlyName "Read_Cache_Enabled" -CNodeCount 8
```
   >Test deployment in given Subscription, Resource Group, Region and Zone with maximum number of Standard_L64s_v3 Read Cache Enabled SKU CNodes.

#### 5. Test with configuration from Silk Deployment Checklist JSON with an alternative test resource group and specific zone
```powershell
Test-SilkResourceDeployment -ChecklistJSON "C:\configs\silk-deployment.json" -ResourceGroupName 'test-rg' -Zone 3
```
   >Loads Subscription and Region values from the JSON file as well as CNode Type and Count, MNode Size and Count. Overrides the Resource Group and Zone Values to test in 'test-rg' for zone 3.

---

### Additional Notes

- **No Risk Minimal Cost:** Temporary test resources are created and cleaned up automatically within minutes *(see [Advanced Usage]#advanced-usage).
- **Isolated Deployment:** Deployed resources will not be associated to any previously existing resources (Other than Subscription and Resource Group) complete network isolation.

---

## Advanced Usage

### Advanced Parameters

| Parameter               | Description | Valid Input | Example | Overrides ChecklistJSON |
|-------------------------|-------------|-------------|---------|-------------------------|
| `-CNodeSku`             | Explicit CNode VM SKU selection for advanced control.<br><br>Valid options:<br> &nbsp;Increased_Logical_Capacity (Standard_E64s_v5)<br> &nbsp;Read_Cache_Enabled (Standard_L64s_v3)<br> &nbsp;No_Increased_Logical_Capacity (Standard_D64s_v5)<br>Use for scenarios requiring specific SKU control. | <br>"Standard_E64s_v5"<br>"Standard_L64s_v3"<br>"Standard_D64s_v5" | "Standard_E64s_v5" | ⬜️ |
| `-MNodeSku`             | Array of explicit Azure VM SKUs for MNode/DNode VMs.<br><br>Lsv3 SKUs:<br> &nbsp;Standard_L8s_v3 (19.5 TiB)<br> &nbsp;Standard_L16s_v3 (39.1 TiB)<br> &nbsp;Standard_L32s_v3 (78.2 TiB)<br>Laosv4 SKUs:<br> &nbsp;Standard_L2aos_v4 (14.67 TiB)<br> &nbsp;Standard_L4aos_v4 (29.34 TiB)<br> &nbsp;Standard_L8aos_v4 (58.67 TiB)<br> &nbsp;Standard_L12aos_v4 (88.01 TiB)<br> &nbsp;Standard_L16aos_v4 (117.35 TiB)<br>Use for advanced scenarios requiring specific SKU control. | "Standard_L8s_v3"<br>"Standard_L16s_v3"<br>"Standard_L32s_v3"<br>"Standard_L2aos_v4"<br>"Standard_L4aos_v4"<br>"Standard_L8aos_v4"<br>"Standard_L12aos_v4"<br>"Standard_L16aos_v4" | @("Standard_L16s_v3", "Standard_L32s_v3") | ⬜️ |
| `-MNodeCount`           | Number of MNode instances to deploy when using explicit SKU selection. | Minimum of 1 -> Maximum of 4 | 2 | ⬜️ |
| `-NoHTMLReport`         | Disable HTML report generation.<br><br>By default, a comprehensive HTML report is generated summarizing deployment status, quota usage, SKU support, and resource validation results. | Switch<br>(present or not) | `-NoHTMLReport` | ⬜️ |
| `-ReportOutputPath`     | Path to save the HTML report.<br><br>Default: Current working directory | <br>".\\valid\\ouput\\path\\" | "C:\\results\\ouput\\" | ⬜️ |
| `-DisableCleanup`       | Prevent automatic cleanup of test resources after validation.<br><br>When specified, test resources remain in Azure for manual inspection or extended testing. | Switch<br>(present or not) | `-DisableCleanup` | ⬜️ |
| `-RunCleanupOnly`       | Only perform cleanup operations, removing all previously created test resources based on <br>`-ResourceNamePrefix`<br> naming.<br><br>Use to clean up resources from failed deployments or when cleanup was disabled. | Switch<br>(present or not) | `-RunCleanupOnly` | ⬜️ |
| `-IPRangeCIDR`          | CIDR notation for VNet and subnet IP address range.<br><br>Default: "10.0.0.0/24" (provides 254 usable IP addresses) | <br>"10.0.0.0/24"<br>"192.168.1.0/24" | "10.0.0.0/24" | ☑️ |
| `-CreateResourceGroup`  | Create resource group by the given name.  It will only be created and deployed to if it does not exist.  It will only be removed by manual confirmation<br><br>Requires elevated Subscription level role assignment. | Switch<br>(present or not) | `-CreateResourceGroup` | ⬜️ |
| `-VMImageOffer`         | Azure Marketplace image offer for VM operating system.<br><br>Default: "0001-com-ubuntu-server-jammy" (Ubuntu 22.04 LTS) | <br>"0001-com-ubuntu-server-jammy"<br>"0001-com-ubuntu-server-focal" | "0001-com-ubuntu-server-jammy" | ⬜️ |
| `-VMImagePublisher`     | Azure Marketplace image publisher for VM operating system.<br><br>Default: "Canonical" (official Ubuntu publisher) | <br>"Canonical"<br>"MicrosoftWindowsServer" | "Canonical" | ⬜️ |
| `-VMImageSku`           | Azure Marketplace image SKU for VM operating system.<br><br>If not specified, automatically selects the latest available SKU with Gen2 preference. | <br>"22_04-lts-gen2"<br>"2019-datacenter" | "22_04-lts-gen2" | ⬜️ |
| `-VMImageVersion`       | Azure Marketplace image version for VM operating system.<br><br>Default: "latest" (automatically uses most recent image version) | <br>"latest"<br>"2023.08.15" | "latest" | ⬜️ |
| `-ResourceNamePrefix`   | Prefix string used for all created Azure resource names to enable easy identification and cleanup.<br><br>Default: "sdp-test" | string [a-zA-Z][a-zA-Z0-9-]{14} | "sdp-test" | ⬜️ |
| `-VMInstanceCredential` | PowerShell credential object containing username and password for VM local administrator account. | <br>PSCredential object<br> | $VMInstanceCredential | ⬜️ |

---

### Advanced Examples
#### 1.1 Advanced: Mixed Friendly CNode and Explicit MNode SKU Selection
```powershell
Test-SilkResourceDeployment -SubscriptionId "12345678-1234-1234-1234-123456789012" -ResourceGroupName "silk-rg-01" -Region "eastus2" -Zone "1" -CNodeFriendlyName "Read_Cache_Enabled" -CNodeCount 3 -MNodeSku @("Standard_L4aos_v4") -MNodeCount 1
```
   >Deploys three Standard_L64s_v3 Read Cache capable CNodes and a single MNode of the specified Standard_L4aos_v4 SKU.

#### 1.2 Advanced: Mixed Explicit CNode SKU and Laosv4 MNode size Selection
```powershell
Test-SilkResourceDeployment -SubscriptionId "12345678-1234-1234-1234-123456789012" -ResourceGroupName "silk-rg-01" -Region "eastus2" -Zone "1" -CNodeSku "Standard_D64s_v5" -CNodeCount -CNodeCount 5 -MnodeSizeLaosv4 @("14.67","88.01")
```
   >Deploys five SKU specified Standard_D64s_v5 standard production CNodes and two Laosv4 MNodes one with 14.67 TiB and second with 88.01 TiB storage capacity.

#### 2.1 Advanced: Explicit SKU Selection and No Cleanup
```powershell
Test-SilkResourceDeployment -SubscriptionId "12345678-1234-1234-1234-123456789012" -ResourceGroupName "silk-test-rg" -Region "westus2" -Zone "2" -CNodeSku "Standard_E64s_v5" -CNodeCount 4 -MNodeSku @("Standard_L16s_v3","Standard_L32s_v3") -MNodeCount 1 -DisableCleanup
```
   >Deploys 4 CNodes with Standard_E64s_v5 SKU and two MNodes one of each of the specified Standard_L16s_v3 and Standard_L32s_v3 SKUs. Disables automatic cleanup for prolonged inspection of the deployed resources.

#### 2.2 Advanced: Explicit SKU Selection and Resource Group Creation
```powershell
Test-SilkResourceDeployment -SubscriptionId "12345678-1234-1234-1234-123456789012" -ResourceGroupName "silk-new-rg" -Region "westus2" -Zone "3" -MNodeSku @("Standard_L8s_v3","Standard_L32s_v3") -MNodeCount 1 -CreateResourceGroup
```
   >Creates a new "silk-new-rg" Resource Group and deploys two MNodes one of each specified "Standard_L2s_v3","Standard_L32s_v3" L-series SKUs into that resource group.  Prompts for manual confirmation to delete the newly created "silk-new-rg" Resource Group.

#### 3.1 Advanced: Cleanup Only
```powershell
Test-SilkResourceDeployment -SubscriptionId "12345678-1234-1234-1234-123456789012" -ResourceGroupName "silk-test-rg" -Region "eastus" -Zone "1" -RunCleanupOnly
```
   >Removes all test resources created in the given Subscription, Resource Group based on the value of `-ResourceNamePrefix` (Default: "sdp-test").

#### 3.2 Advanced: Cleanup Only using JSON import
```powershell
Test-SilkResourceDeployment  -ChecklistJSON "C:\configs\silk-deployment.json" -ResourceGroupName "silk-test-rg" -RunCleanupOnly -ResourceNamePrefix "custom-name"
```
   >Removes all test resources created in the given Subscription (imported from JSON) Resource Group (overriding JSON Resource Group Value) based on the value of `-ResourceNamePrefix` (Default: "sdp-test").
---
